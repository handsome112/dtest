{"ast":null,"code":"import _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport { merge } from 'lodash';\nimport { createReducers } from '@lib/redux';\nimport { getConversations, getConversationsSuccess, getConversationsFail, searchConversations, searchConversationsSuccess, searchConversationsFail, setActiveConversationSuccess, fetchingMessage, loadMessagesSuccess, sendMessage, sendMessageSuccess, sendMessageFail, getConversationDetailSuccess, receiveMessageSuccess, readMessages, sentFileSuccess, loadMoreMessagesSuccess, deactiveConversation, resetMessageState, updateLastMessage, countNotReadMessage } from './actions';\nvar initialConversationState = {\n  list: {\n    requesting: false,\n    error: null,\n    data: [],\n    total: 0,\n    success: false\n  },\n  mapping: {},\n  activeConversation: {}\n};\nvar initialMessageState = {\n  // conversationId => { fetching: boolean, items: [] }\n  conversationMap: {},\n  sendMessage: {},\n  receiveMessage: {},\n  totalNotReadMessage: 0\n};\nvar conversationReducer = [{\n  on: resetMessageState,\n  reducer: function reducer(state) {\n    var list = state.list,\n        mapping = state.mapping,\n        activeConversation = state.activeConversation;\n    list = {\n      requesting: false,\n      error: null,\n      data: [],\n      total: 0,\n      success: false\n    };\n    mapping = {};\n    activeConversation = {};\n    return _objectSpread(_objectSpread({}, state), {}, {\n      list: list,\n      mapping: mapping,\n      activeConversation: activeConversation\n    });\n  }\n}, {\n  on: getConversations,\n  reducer: function reducer(state) {\n    var nextState = _objectSpread({}, state);\n\n    nextState.list.requesting = true;\n    return _objectSpread({}, nextState);\n  }\n}, {\n  on: getConversationsSuccess,\n  reducer: function reducer(state, data) {\n    var nextState = _objectSpread({}, state);\n\n    var list = nextState.list,\n        mapping = nextState.mapping;\n    var _data$payload = data.payload,\n        items = _data$payload.data,\n        total = _data$payload.total;\n    var Ids = items.map(function (c) {\n      return c._id;\n    });\n    list.data = list.data.concat(Ids);\n    list.total = total;\n    list.success = true;\n    list.requesting = false;\n    list.error = false;\n    items.forEach(function (c) {\n      mapping[c._id] = c;\n    });\n    return _objectSpread({}, nextState);\n  }\n}, {\n  on: getConversationsFail,\n  reducer: function reducer(state, data) {\n    var nextState = _objectSpread({}, state);\n\n    return _objectSpread(_objectSpread({}, nextState), {}, {\n      list: {\n        requesting: false,\n        error: data.payload,\n        data: [],\n        total: 0,\n        success: false\n      },\n      mapping: {},\n      activeConversation: {}\n    });\n  }\n}, {\n  on: searchConversations,\n  reducer: function reducer(state) {\n    var nextState = _objectSpread({}, state);\n\n    return _objectSpread(_objectSpread({}, nextState), {}, {\n      list: {\n        requesting: true,\n        error: null,\n        data: [],\n        total: 0,\n        success: false\n      },\n      mapping: {},\n      activeConversation: {}\n    });\n  }\n}, {\n  on: searchConversationsSuccess,\n  reducer: function reducer(state, data) {\n    var nextState = _objectSpread({}, state);\n\n    var list = nextState.list,\n        mapping = nextState.mapping;\n    var _data$payload2 = data.payload,\n        items = _data$payload2.data,\n        total = _data$payload2.total;\n    var Ids = items.map(function (c) {\n      return c._id;\n    });\n    list.data = Ids;\n    list.total = total;\n    list.success = true;\n    list.requesting = false;\n    list.error = false;\n    items.forEach(function (c) {\n      mapping[c._id] = c;\n    });\n    return _objectSpread({}, nextState);\n  }\n}, {\n  on: searchConversationsFail,\n  reducer: function reducer(state, data) {\n    var nextState = _objectSpread({}, state);\n\n    return _objectSpread(_objectSpread({}, nextState), {}, {\n      list: {\n        requesting: false,\n        error: data.payload,\n        data: [],\n        total: 0,\n        success: false\n      },\n      mapping: {},\n      activeConversation: {}\n    });\n  }\n}, {\n  on: setActiveConversationSuccess,\n  reducer: function reducer(state, data) {\n    var conversation = data.payload;\n    var list = state.list.data;\n    var mapping = state.mapping;\n    var check = list.find(function (c) {\n      return c === conversation._id;\n    });\n\n    if (!check) {\n      list.unshift(conversation._id);\n      mapping[conversation._id] = conversation;\n    }\n\n    return _objectSpread(_objectSpread({}, state), {}, {\n      activeConversation: conversation\n    });\n  }\n}, {\n  on: getConversationDetailSuccess,\n  reducer: function reducer(state, data) {\n    var list = state.list,\n        mapping = state.mapping;\n    var conversation = data.payload;\n\n    if (!list.data.includes(conversation._id)) {\n      list.data.unshift(conversation._id);\n      mapping[conversation._id] = conversation;\n    }\n\n    return _objectSpread({}, state);\n  }\n}, {\n  on: readMessages,\n  reducer: function reducer(state, data) {\n    var conversationId = data.payload;\n    var mapping = state.mapping;\n    mapping[conversationId].totalNotSeenMessages = 0;\n    return _objectSpread({}, state);\n  }\n}, {\n  on: deactiveConversation,\n  reducer: function reducer(state) {\n    var nextState = _objectSpread({}, state);\n\n    nextState.activeConversation = {};\n    return _objectSpread({}, nextState);\n  }\n}, {\n  on: updateLastMessage,\n  reducer: function reducer(state, action) {\n    var _action$payload = action.payload,\n        conversationId = _action$payload.conversationId,\n        lastMessage = _action$payload.lastMessage;\n    var mapping = state.mapping;\n\n    if (mapping[conversationId]) {\n      mapping[conversationId].lastMessage = lastMessage;\n      mapping[conversationId].lastMessageCreatedAt = new Date();\n      mapping[conversationId].totalNotSeenMessages = 0;\n    }\n\n    return _objectSpread({}, state);\n  }\n}];\nvar messageReducer = [{\n  on: fetchingMessage,\n  reducer: function reducer(state, data) {\n    var conversationMap = state.conversationMap;\n    var conversationId = data.payload.conversationId;\n    conversationMap[conversationId] = _objectSpread(_objectSpread({}, conversationMap[conversationId]), {}, {\n      fetching: true\n    });\n    return _objectSpread({}, state);\n  }\n}, {\n  on: loadMessagesSuccess,\n  reducer: function reducer(state, data) {\n    var conversationMap = state.conversationMap;\n    var _data$payload3 = data.payload,\n        conversationId = _data$payload3.conversationId,\n        items = _data$payload3.items,\n        total = _data$payload3.total;\n    conversationMap[conversationId] = {\n      items: _toConsumableArray(items.reverse()),\n      total: total,\n      fetching: false\n    };\n    return _objectSpread({}, state);\n  }\n}, {\n  on: loadMoreMessagesSuccess,\n  reducer: function reducer(state, data) {\n    var conversationMap = state.conversationMap;\n    var _data$payload4 = data.payload,\n        conversationId = _data$payload4.conversationId,\n        items = _data$payload4.items,\n        total = _data$payload4.total;\n    conversationMap[conversationId] = {\n      items: [].concat(_toConsumableArray(items.reverse()), _toConsumableArray(conversationMap[conversationId].items || [])),\n      total: total,\n      fetching: false\n    };\n    return _objectSpread({}, state);\n  }\n}, {\n  on: sendMessage,\n  reducer: function reducer(state) {\n    return _objectSpread(_objectSpread({}, state), {}, {\n      sendMessage: {\n        sending: true\n      }\n    });\n  }\n}, {\n  on: sendMessageSuccess,\n  reducer: function reducer(state, data) {\n    var nextState = _objectSpread({}, state);\n\n    if (!nextState.conversationMap[data.payload.conversationId] || !nextState.conversationMap[data.payload.conversationId].items) {\n      nextState.conversationMap[data.payload.conversationId].items = [];\n    }\n\n    nextState.conversationMap[data.payload.conversationId].items.push(data.payload);\n    return _objectSpread(_objectSpread({}, nextState), {}, {\n      sendMessage: {\n        sending: false,\n        success: true,\n        data: data.payload\n      }\n    });\n  }\n}, {\n  on: sendMessageFail,\n  reducer: function reducer(state, data) {\n    return _objectSpread(_objectSpread({}, state), {}, {\n      sendMessage: {\n        sending: false,\n        success: false,\n        error: data.payload\n      }\n    });\n  }\n}, {\n  on: receiveMessageSuccess,\n  reducer: function reducer(state, data) {\n    var nextState = _objectSpread({}, state);\n\n    if (!nextState.conversationMap[data.payload.conversationId]) {\n      return _objectSpread({}, nextState);\n    }\n\n    nextState.conversationMap[data.payload.conversationId].items.push(data.payload);\n    return _objectSpread(_objectSpread({}, nextState), {}, {\n      receiveMessage: data.payload\n    });\n  }\n}, {\n  on: sentFileSuccess,\n  reducer: function reducer(state, data) {\n    var nextState = _objectSpread({}, state);\n\n    if (!nextState.conversationMap[data.payload.conversationId] || !nextState.conversationMap[data.payload.conversationId].items) {\n      nextState.conversationMap[data.payload.conversationId].items = [];\n    }\n\n    nextState.conversationMap[data.payload.conversationId].items.push(data.payload);\n    return _objectSpread(_objectSpread({}, nextState), {}, {\n      sendMessage: {\n        sending: false,\n        success: true,\n        data: data.payload\n      }\n    });\n  }\n}, {\n  on: countNotReadMessage,\n  reducer: function reducer(state, action) {\n    return _objectSpread(_objectSpread({}, state), {}, {\n      totalNotReadMessage: action.payload\n    });\n  }\n}];\nexport default merge({}, createReducers('conversation', [conversationReducer], initialConversationState), createReducers('message', [messageReducer], initialMessageState));","map":null,"metadata":{},"sourceType":"module"}